import axios from "axios";

import { getToken } from "./auth";
import { decodeJwt, JWTPayload } from "jose";
import { API_URL } from "./constants";

type UserPayload = JWTPayload & {
    email: string;
    exp: number;
    first_name: string;
    iat: number;
    is_superuser: boolean;
    jti: string;
    last_name: string;
    refresh_exp: number;
    token_type: string;
    user_id: number;
    username: string;
};

export interface User {
    id: number;
    firstName: string;
    lastName: string;
    email: string;
    username: string;
    isAdmin: boolean;
}

export async function getCurrentUser(): Promise<User> {
    const token = getToken();

    let response;
    try {
        response = await axios.get(`${API_URL}/user/`, {
            headers: {
                authorization: `Bearer ${token}`,
            },
        });
    } catch (error) {
        return undefined;
    }

    return response.data;
}

export function getUserClaims(): User {
    const token = getToken();

    if (!token) {
        return undefined;
    }

    // @ts-ignore
    const decoded: UserPayload = decodeJwt(token);

    if (!decoded || decoded.exp < Date.now() / 1000) {
        return undefined;
    }

    return {
        id: decoded.user_id,
        firstName: decoded.first_name,
        lastName: decoded.last_name,
        email: decoded.email,
        username: decoded.username,
        isAdmin: decoded.is_superuser,
    };
}
